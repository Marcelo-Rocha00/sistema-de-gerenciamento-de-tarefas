<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
</head>
<body>
    {% csrf_token %}
    <h1>Perfil do Usuário</h1>
    
    <p>Nome de Usuário: {{ username }}</p>

    <form method="GET" action="{% url 'usuario' %}" >
        <input type="text" placeholder="Buscar..." name="titulo" value="{{ titulo_busca }}">
        <button type="submit">Pesquisar</button>
    </form>

    <form action="{% url 'usuario' %}" method="post">
        {% csrf_token %}
        <label for="status">Filtrar por status:</label>

        <select name="status" id="status">
            <option value="true" {% if form.status.value == 'true' %}selected{% endif %}>Concluídas</option>
            <option value="false" {% if form.status.value == 'false' %}selected{% endif %}>Pendentes</option>
        </select>
        <button type="submit">Filtrar</button>
    </form>

    <p>Tarefas atribuídas:</p>

    <ul>
        {% for task in tasks %}
            <li>
                <a href="{% url 'detalhes_task' task.id %}">{{ task.titulo }}</a>
                {% if task.status %} - Concluída {% else %} - Pendente {% endif %} 
                <form action="{% url 'delete_task' task.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="button" onclick="deleteTask({{ task.id }})">Excluir</button>
                </form>
            </li>
        {% empty %}
        <li>Não há tarefas atribuídas.</li>
        {% endfor %}
    </ul>

    <form action="{% url 'add_task' %}" method="get" style="display:inline;">
        {% csrf_token %}
        <button type="submit">Adicionar nova Tarefa</button>
    </form>

    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <script>
        const token = localStorage.getItem('auth_token');  // Recupera o token
        console.log("Token recuperado:", token);  // Verifique se o token está correto


        async function deleteTask(taskId) {
            const response = await fetch(`http://127.0.0.1:8000/api/tasks/${taskId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Token ${token}`,
                },
            });

            if (response.ok) {
                alert('Tarefa excluída com sucesso!');
                location.reload();  // Recarrega a página para atualizar a lista
            } else {
                alert('Erro ao excluir tarefa');
            }
        }
    </script>
</body>
</html>
